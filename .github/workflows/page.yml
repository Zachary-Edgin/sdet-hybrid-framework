name: Publish test report to GitHub Pages (demo)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Build and start app
        run: docker compose up -d --build app

      - name: Build tests image
        run: docker compose build tests

      - name: Run tests (always produce artifacts)
        shell: bash
        run: |
          set +e
          docker compose run --rm tests pytest \
            -q \
            --junitxml=/work/artifacts/junit.xml \
            --html=/work/artifacts/report.html --self-contained-html
          echo $? > artifacts/exit_code.txt
          exit 0

      # Generate a polished index.html for Pages
      - name: Generate landing page (index.html)
        shell: bash
        run: |
          python - <<'PY'
          import os, glob, xml.etree.ElementTree as ET
          from datetime import datetime, timezone

          junit_path = "artifacts/junit.xml"
          exit_code_path = "artifacts/exit_code.txt"

          status = "UNKNOWN"
          exit_code = None
          if os.path.exists(exit_code_path):
            try:
              exit_code = int(open(exit_code_path).read().strip() or "0")
              status = "PASS" if exit_code == 0 else "FAIL"
            except Exception:
              pass

          totals = dict(tests=0, failures=0, errors=0, skipped=0, time=0.0)
          failed_cases = []

          if os.path.exists(junit_path):
            root = ET.parse(junit_path).getroot()
            # junitxml may be <testsuite> or <testsuites>
            suites = []
            if root.tag == "testsuite":
              suites = [root]
            elif root.tag == "testsuites":
              suites = root.findall("testsuite")

            for s in suites:
              totals["tests"] += int(s.attrib.get("tests", 0))
              totals["failures"] += int(s.attrib.get("failures", 0))
              totals["errors"] += int(s.attrib.get("errors", 0))
              totals["skipped"] += int(s.attrib.get("skipped", 0))
              totals["time"] += float(s.attrib.get("time", 0.0))

              for tc in s.findall("testcase"):
                name = tc.attrib.get("name", "")
                classname = tc.attrib.get("classname", "")
                if tc.find("failure") is not None or tc.find("error") is not None:
                  failed_cases.append(f"{classname}::{name}".strip(":"))

          screenshots = sorted(glob.glob("artifacts/*.png"))
          now = datetime.now(timezone.utc).strftime("%Y-%m-%d %H:%M:%S UTC")

          def esc(s: str) -> str:
            return (s.replace("&","&amp;").replace("<","&lt;").replace(">","&gt;")
                     .replace('"',"&quot;").replace("'","&#39;"))

          badge = "ðŸŸ¢ PASS" if status == "PASS" else ("ðŸ”´ FAIL" if status == "FAIL" else "âšª UNKNOWN")

          html = f"""<!doctype html>
          <html lang="en">
          <head>
            <meta charset="utf-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1" />
            <title>SDET Hybrid Framework â€“ Test Report</title>
            <style>
              body {{
                font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
                margin: 0; padding: 0; background: #0b1220; color: #e8eefc;
              }}
              .wrap {{ max-width: 980px; margin: 0 auto; padding: 28px 18px 60px; }}
              .card {{
                background: #111a2e; border: 1px solid rgba(255,255,255,.08);
                border-radius: 14px; padding: 18px; margin-top: 14px;
              }}
              h1 {{ margin: 0 0 6px; font-size: 22px; }}
              .sub {{ opacity: .8; font-size: 13px; }}
              .row {{ display: flex; gap: 12px; flex-wrap: wrap; }}
              .stat {{
                flex: 1; min-width: 160px;
                background: rgba(255,255,255,.05);
                border: 1px solid rgba(255,255,255,.08);
                border-radius: 12px; padding: 12px;
              }}
              .stat b {{ display: block; font-size: 22px; margin-top: 6px; }}
              .btns {{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }}
              a.btn {{
                display:inline-block; padding: 10px 12px; border-radius: 12px;
                background: #2b64ff; color: white; text-decoration:none; font-weight: 600;
              }}
              a.btn.secondary {{ background: rgba(255,255,255,.10); }}
              code {{ background: rgba(255,255,255,.06); padding: 2px 6px; border-radius: 8px; }}
              ul {{ margin: 8px 0 0 18px; }}
              li {{ margin: 6px 0; }}
              .pill {{
                display:inline-block; padding: 6px 10px; border-radius: 999px;
                background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.10);
                font-weight: 700;
              }}
            </style>
          </head>
          <body>
            <div class="wrap">
              <div class="card">
                <h1>SDET Hybrid Framework â€“ CI Test Report</h1>
                <div class="sub">Updated: {esc(now)} Â· Status: <span class="pill">{esc(badge)}</span></div>

                <div class="btns">
                  <a class="btn" href="./report.html">Open HTML report</a>
                  <a class="btn secondary" href="./junit.xml">Download JUnit XML</a>
                </div>
              </div>

              <div class="card">
                <div class="row">
                  <div class="stat">Total tests<b>{totals["tests"]}</b></div>
                  <div class="stat">Failures<b>{totals["failures"]}</b></div>
                  <div class="stat">Errors<b>{totals["errors"]}</b></div>
                  <div class="stat">Skipped<b>{totals["skipped"]}</b></div>
                  <div class="stat">Runtime (s)<b>{totals["time"]:.2f}</b></div>
                </div>
              </div>

              <div class="card">
                <h2 style="margin:0 0 8px; font-size:16px;">Failing tests</h2>
                {"<div class='sub'>None âœ…</div>" if not failed_cases else "<ul>" + "".join(f"<li><code>{esc(x)}</code></li>" for x in failed_cases[:15]) + "</ul>"}
                {"" if len(failed_cases) <= 15 else f"<div class='sub'>Showing first 15 of {len(failed_cases)}.</div>"}
              </div>

              <div class="card">
                <h2 style="margin:0 0 8px; font-size:16px;">Screenshots (UI failures)</h2>
                {"<div class='sub'>No screenshots captured.</div>" if not screenshots else "<ul>" + "".join(f"<li><a class='btn secondary' href='./{os.path.basename(p)}'>View {esc(os.path.basename(p))}</a></li>" for p in screenshots) + "</ul>"}
              </div>

              <div class="card">
                <div class="sub">
                  Tip: This page is published from <code>main</code>. Feature branches still upload downloadable artifacts in Actions.
                </div>
              </div>
            </div>
          </body>
          </html>
          """

          with open("artifacts/index.html", "w", encoding="utf-8") as f:
            f.write(html)
          print("Wrote artifacts/index.html")
          PY

      # Keep the downloadable artifact for hiring managers / reviewers
      - name: Upload downloadable artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          path: artifacts/

      # Publish same files to Pages
      - name: Upload Pages artifact
        if: always()
        uses: actions/upload-pages-artifact@v3
        with:
          path: artifacts/

  deploy:
    needs: test
    if: always()
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    steps:
      - uses: actions/deploy-pages@v4